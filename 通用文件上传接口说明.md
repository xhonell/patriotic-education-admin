# 通用文件上传接口说明 📤

## 📡 接口信息

### 基本信息
- **URL**: `/server/common/upload`
- **方法**: `POST`
- **Content-Type**: `multipart/form-data`
- **认证**: 需要 token

## 📋 请求格式

### FormData 参数
```javascript
const formData = new FormData()
formData.append('file', file)  // file 为 File 对象
```

### 请求头
```javascript
{
  'Content-Type': 'multipart/form-data',
  'Authorization': 'Bearer {token}'
}
```

## 📊 响应格式

### 成功响应
```java
// 后端响应实体
{
  private static final long serialVersionUID = 1L;
  private Long fileId;        // 文件ID
  private String filePathUrl; // 文件访问URL
}
```

### 完整响应示例
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "fileId": 100,
    "filePathUrl": "https://pe-1329896228.cos.ap-chengdu.myqcloud.com/images/xxx.jpg"
  }
}
```

## 💻 前端实现

### 1. API 接口封装

#### src/api/banner.js
```javascript
import request from '@/utils/request'

/**
 * 上传轮播图图片（通用文件上传接口）
 * @param {FormData} formData - 图片文件
 * @returns {Promise<{fileId: Long, filePathUrl: String}>}
 */
export function uploadBannerImage(formData) {
  return request({
    url: '/server/common/upload',
    method: 'post',
    data: formData,
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

### 2. 页面使用

#### 上传前校验
```javascript
const beforeUpload = (file) => {
  // 检查文件类型
  const isJPG = file.type === 'image/jpeg' || file.type === 'image/png'
  if (!isJPG) {
    ElMessage.error('只能上传 JPG/PNG 格式的图片！')
    return false
  }
  
  // 检查文件大小
  const isLt2M = file.size / 1024 / 1024 < 2
  if (!isLt2M) {
    ElMessage.error('图片大小不能超过 2MB！')
    return false
  }
  
  return true
}
```

#### 上传处理
```javascript
const handleUpload = async ({ file }) => {
  try {
    // 创建 FormData
    const formData = new FormData()
    formData.append('file', file)
    
    // 调用上传接口
    const result = await uploadBannerImage(formData)
    
    // 保存返回的数据
    bannerForm.fileId = result.fileId              // 文件ID
    bannerForm.filePathUrl = result.filePathUrl    // 文件URL
    
    console.log('上传成功：', {
      fileId: result.fileId,
      filePathUrl: result.filePathUrl
    })
    
    ElMessage.success('图片上传成功')
  } catch (error) {
    console.error('图片上传失败：', error)
    ElMessage.error('图片上传失败，请重试')
  }
}
```

#### 表单提交
```javascript
const handleSubmit = async () => {
  const data = {
    title: bannerForm.title,
    fileId: bannerForm.fileId,      // 提交文件ID
    status: bannerForm.status
  }
  
  if (bannerForm.id) {
    await updateBanner(data)  // 编辑
  } else {
    await addBanner(data)      // 新增
  }
}
```

### 3. Element Plus 上传组件

```vue
<template>
  <el-upload
    class="banner-uploader"
    :show-file-list="false"
    :before-upload="beforeUpload"
    action="#"
    :http-request="handleUpload"
  >
    <img v-if="bannerForm.filePathUrl" :src="bannerForm.filePathUrl" class="banner-image">
    <el-icon v-else class="banner-uploader-icon"><Plus /></el-icon>
  </el-upload>
  <div class="upload-tip">建议尺寸：1920x600px，支持jpg、png格式，大小不超过2MB</div>
</template>
```

## 🎯 字段说明

### 请求字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | File | ✅ 是 | 要上传的文件对象 |

### 响应字段

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| fileId | Long | 文件ID | 100 |
| filePathUrl | String | 文件访问URL | https://xxx.cos.ap-chengdu.myqcloud.com/xxx.jpg |

## 🔧 代理配置

### Vite 代理设置
```javascript
// vite.config.js
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8801',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})
```

### 请求路径转换
```
前端请求：POST /api/server/common/upload
         ↓
实际请求：POST http://localhost:8801/server/common/upload
```

## 📊 完整数据流

### 上传流程
```
用户选择文件
    ↓
触发 beforeUpload 校验
    ↓
创建 FormData
formData.append('file', file)
    ↓
调用 uploadBannerImage(formData)
    ↓
POST /api/server/common/upload
    ↓
后端处理上传
    ↓
返回 { fileId, filePathUrl }
    ↓
保存到表单
bannerForm.fileId = result.fileId
bannerForm.filePathUrl = result.filePathUrl
    ↓
显示预览图片
<img :src="bannerForm.filePathUrl">
```

### 提交流程
```
用户填写表单
    ↓
上传图片 → 获取 fileId 和 filePathUrl
    ↓
点击提交
    ↓
发送数据 { title, fileId, status }
    ↓
POST /api/admin/banner/add
    ↓
后端保存轮播图记录
    ↓
成功返回
    ↓
刷新列表
```

## 🎨 使用示例

### 完整组件示例
```vue
<template>
  <el-form :model="bannerForm" :rules="bannerRules">
    <el-form-item label="标题" prop="title">
      <el-input v-model="bannerForm.title" />
    </el-form-item>
    
    <el-form-item label="图片" prop="filePathUrl">
      <el-upload
        :show-file-list="false"
        :before-upload="beforeUpload"
        action="#"
        :http-request="handleUpload"
      >
        <img v-if="bannerForm.filePathUrl" :src="bannerForm.filePathUrl">
        <el-icon v-else><Plus /></el-icon>
      </el-upload>
    </el-form-item>
    
    <el-form-item label="状态" prop="status">
      <el-switch v-model="bannerForm.status" />
    </el-form-item>
  </el-form>
</template>

<script setup>
import { reactive } from 'vue'
import { uploadBannerImage } from '@/api/banner'

const bannerForm = reactive({
  title: '',
  fileId: null,
  filePathUrl: '',
  status: true
})

const beforeUpload = (file) => {
  const isImage = file.type.startsWith('image/')
  const isLt2M = file.size / 1024 / 1024 < 2
  
  if (!isImage) {
    ElMessage.error('只能上传图片文件！')
    return false
  }
  if (!isLt2M) {
    ElMessage.error('图片大小不能超过 2MB！')
    return false
  }
  return true
}

const handleUpload = async ({ file }) => {
  const formData = new FormData()
  formData.append('file', file)
  
  const result = await uploadBannerImage(formData)
  bannerForm.fileId = result.fileId
  bannerForm.filePathUrl = result.filePathUrl
  
  ElMessage.success('上传成功')
}
</script>
```

## 🔍 调试技巧

### 1. 查看上传的文件
```javascript
const handleUpload = async ({ file }) => {
  console.log('上传的文件：', {
    name: file.name,
    size: file.size,
    type: file.type,
    lastModified: new Date(file.lastModified)
  })
  
  // ... 上传逻辑
}
```

### 2. 查看 FormData 内容
```javascript
const formData = new FormData()
formData.append('file', file)

// 查看 FormData 内容
for (let pair of formData.entries()) {
  console.log(pair[0], pair[1])
}
```

### 3. 查看响应数据
```javascript
const result = await uploadBannerImage(formData)
console.log('上传响应：', {
  fileId: result.fileId,
  filePathUrl: result.filePathUrl,
  完整响应: result
})
```

### 4. 错误处理
```javascript
try {
  const result = await uploadBannerImage(formData)
  // 成功处理
} catch (error) {
  console.error('上传失败：', {
    message: error.message,
    response: error.response?.data,
    status: error.response?.status
  })
  ElMessage.error('上传失败，请重试')
}
```

## ⚠️ 注意事项

### 1. 文件大小限制
- ✅ 前端限制：2MB
- ⚠️ 后端可能有不同的限制
- 📝 建议：与后端确认最大文件大小

### 2. 文件类型限制
```javascript
// 支持的图片类型
const allowedTypes = [
  'image/jpeg',
  'image/png',
  'image/gif',
  'image/webp'
]

const isAllowed = allowedTypes.includes(file.type)
```

### 3. 网络超时
```javascript
// 设置上传超时时间
export function uploadBannerImage(formData) {
  return request({
    url: '/server/common/upload',
    method: 'post',
    data: formData,
    timeout: 30000,  // 30秒超时
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

### 4. 进度显示
```javascript
const handleUpload = async ({ file }) => {
  const formData = new FormData()
  formData.append('file', file)
  
  const result = await uploadBannerImage(formData, {
    onUploadProgress: (progressEvent) => {
      const percentCompleted = Math.round(
        (progressEvent.loaded * 100) / progressEvent.total
      )
      console.log('上传进度：', percentCompleted + '%')
    }
  })
}
```

## 📋 接口对接检查清单

- [x] URL 正确：`/server/common/upload`
- [x] 方法正确：`POST`
- [x] Content-Type：`multipart/form-data`
- [x] 参数名称：`file`
- [x] 响应字段：`fileId`, `filePathUrl`
- [x] 前端校验：文件类型、大小
- [x] 错误处理：try-catch
- [x] 成功提示：ElMessage.success
- [x] 失败提示：ElMessage.error
- [x] 预览功能：显示上传的图片

## 🚀 测试步骤

### 1. 准备测试图片
```
准备一张测试图片：
- 格式：JPG 或 PNG
- 尺寸：1920x600px（推荐）
- 大小：< 2MB
```

### 2. 测试上传
```
1. 打开轮播图管理页面
2. 点击"新增轮播图"
3. 点击上传区域
4. 选择测试图片
5. 查看控制台输出
6. 确认图片预览显示
7. 填写标题
8. 提交表单
9. 查看列表中的图片
```

### 3. 验证数据
```
// 在控制台查看
console.log('fileId:', bannerForm.fileId)
console.log('filePathUrl:', bannerForm.filePathUrl)

// 检查图片是否可访问
window.open(bannerForm.filePathUrl)
```

## 💡 优化建议

### 1. 图片压缩
```javascript
// 可以在上传前压缩图片
import imageCompression from 'browser-image-compression'

const compressImage = async (file) => {
  const options = {
    maxSizeMB: 1,
    maxWidthOrHeight: 1920
  }
  return await imageCompression(file, options)
}
```

### 2. 裁剪功能
```javascript
// 使用 vue-cropper 实现图片裁剪
import VueCropper from 'vue-cropper'

// 裁剪为 1920x600 比例
```

### 3. 拖拽上传
```javascript
// Element Plus 支持拖拽
<el-upload drag>
  <el-icon><UploadFilled /></el-icon>
  <div>将文件拖到此处，或<em>点击上传</em></div>
</el-upload>
```

---

**通用文件上传接口已完整对接！** 📤✨

**接口信息**：
- URL: `/server/common/upload`
- 返回: `{ fileId, filePathUrl }`
- 已在轮播图管理中使用

