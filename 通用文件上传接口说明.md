# é€šç”¨æ–‡ä»¶ä¸Šä¼ æ¥å£è¯´æ˜ ğŸ“¤

## ğŸ“¡ æ¥å£ä¿¡æ¯

### åŸºæœ¬ä¿¡æ¯
- **URL**: `/server/common/upload`
- **æ–¹æ³•**: `POST`
- **Content-Type**: `multipart/form-data`
- **è®¤è¯**: éœ€è¦ token

## ğŸ“‹ è¯·æ±‚æ ¼å¼

### FormData å‚æ•°
```javascript
const formData = new FormData()
formData.append('file', file)  // file ä¸º File å¯¹è±¡
```

### è¯·æ±‚å¤´
```javascript
{
  'Content-Type': 'multipart/form-data',
  'Authorization': 'Bearer {token}'
}
```

## ğŸ“Š å“åº”æ ¼å¼

### æˆåŠŸå“åº”
```java
// åç«¯å“åº”å®ä½“
{
  private static final long serialVersionUID = 1L;
  private Long fileId;        // æ–‡ä»¶ID
  private String filePathUrl; // æ–‡ä»¶è®¿é—®URL
}
```

### å®Œæ•´å“åº”ç¤ºä¾‹
```json
{
  "code": 200,
  "message": "ä¸Šä¼ æˆåŠŸ",
  "data": {
    "fileId": 100,
    "filePathUrl": "https://pe-1329896228.cos.ap-chengdu.myqcloud.com/images/xxx.jpg"
  }
}
```

## ğŸ’» å‰ç«¯å®ç°

### 1. API æ¥å£å°è£…

#### src/api/banner.js
```javascript
import request from '@/utils/request'

/**
 * ä¸Šä¼ è½®æ’­å›¾å›¾ç‰‡ï¼ˆé€šç”¨æ–‡ä»¶ä¸Šä¼ æ¥å£ï¼‰
 * @param {FormData} formData - å›¾ç‰‡æ–‡ä»¶
 * @returns {Promise<{fileId: Long, filePathUrl: String}>}
 */
export function uploadBannerImage(formData) {
  return request({
    url: '/server/common/upload',
    method: 'post',
    data: formData,
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

### 2. é¡µé¢ä½¿ç”¨

#### ä¸Šä¼ å‰æ ¡éªŒ
```javascript
const beforeUpload = (file) => {
  // æ£€æŸ¥æ–‡ä»¶ç±»å‹
  const isJPG = file.type === 'image/jpeg' || file.type === 'image/png'
  if (!isJPG) {
    ElMessage.error('åªèƒ½ä¸Šä¼  JPG/PNG æ ¼å¼çš„å›¾ç‰‡ï¼')
    return false
  }
  
  // æ£€æŸ¥æ–‡ä»¶å¤§å°
  const isLt2M = file.size / 1024 / 1024 < 2
  if (!isLt2M) {
    ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MBï¼')
    return false
  }
  
  return true
}
```

#### ä¸Šä¼ å¤„ç†
```javascript
const handleUpload = async ({ file }) => {
  try {
    // åˆ›å»º FormData
    const formData = new FormData()
    formData.append('file', file)
    
    // è°ƒç”¨ä¸Šä¼ æ¥å£
    const result = await uploadBannerImage(formData)
    
    // ä¿å­˜è¿”å›çš„æ•°æ®
    bannerForm.fileId = result.fileId              // æ–‡ä»¶ID
    bannerForm.filePathUrl = result.filePathUrl    // æ–‡ä»¶URL
    
    console.log('ä¸Šä¼ æˆåŠŸï¼š', {
      fileId: result.fileId,
      filePathUrl: result.filePathUrl
    })
    
    ElMessage.success('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ')
  } catch (error) {
    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š', error)
    ElMessage.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}
```

#### è¡¨å•æäº¤
```javascript
const handleSubmit = async () => {
  const data = {
    title: bannerForm.title,
    fileId: bannerForm.fileId,      // æäº¤æ–‡ä»¶ID
    status: bannerForm.status
  }
  
  if (bannerForm.id) {
    await updateBanner(data)  // ç¼–è¾‘
  } else {
    await addBanner(data)      // æ–°å¢
  }
}
```

### 3. Element Plus ä¸Šä¼ ç»„ä»¶

```vue
<template>
  <el-upload
    class="banner-uploader"
    :show-file-list="false"
    :before-upload="beforeUpload"
    action="#"
    :http-request="handleUpload"
  >
    <img v-if="bannerForm.filePathUrl" :src="bannerForm.filePathUrl" class="banner-image">
    <el-icon v-else class="banner-uploader-icon"><Plus /></el-icon>
  </el-upload>
  <div class="upload-tip">å»ºè®®å°ºå¯¸ï¼š1920x600pxï¼Œæ”¯æŒjpgã€pngæ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡2MB</div>
</template>
```

## ğŸ¯ å­—æ®µè¯´æ˜

### è¯·æ±‚å­—æ®µ

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| file | File | âœ… æ˜¯ | è¦ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡ |

### å“åº”å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| fileId | Long | æ–‡ä»¶ID | 100 |
| filePathUrl | String | æ–‡ä»¶è®¿é—®URL | https://xxx.cos.ap-chengdu.myqcloud.com/xxx.jpg |

## ğŸ”§ ä»£ç†é…ç½®

### Vite ä»£ç†è®¾ç½®
```javascript
// vite.config.js
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8801',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})
```

### è¯·æ±‚è·¯å¾„è½¬æ¢
```
å‰ç«¯è¯·æ±‚ï¼šPOST /api/server/common/upload
         â†“
å®é™…è¯·æ±‚ï¼šPOST http://localhost:8801/server/common/upload
```

## ğŸ“Š å®Œæ•´æ•°æ®æµ

### ä¸Šä¼ æµç¨‹
```
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
    â†“
è§¦å‘ beforeUpload æ ¡éªŒ
    â†“
åˆ›å»º FormData
formData.append('file', file)
    â†“
è°ƒç”¨ uploadBannerImage(formData)
    â†“
POST /api/server/common/upload
    â†“
åç«¯å¤„ç†ä¸Šä¼ 
    â†“
è¿”å› { fileId, filePathUrl }
    â†“
ä¿å­˜åˆ°è¡¨å•
bannerForm.fileId = result.fileId
bannerForm.filePathUrl = result.filePathUrl
    â†“
æ˜¾ç¤ºé¢„è§ˆå›¾ç‰‡
<img :src="bannerForm.filePathUrl">
```

### æäº¤æµç¨‹
```
ç”¨æˆ·å¡«å†™è¡¨å•
    â†“
ä¸Šä¼ å›¾ç‰‡ â†’ è·å– fileId å’Œ filePathUrl
    â†“
ç‚¹å‡»æäº¤
    â†“
å‘é€æ•°æ® { title, fileId, status }
    â†“
POST /api/admin/banner/add
    â†“
åç«¯ä¿å­˜è½®æ’­å›¾è®°å½•
    â†“
æˆåŠŸè¿”å›
    â†“
åˆ·æ–°åˆ—è¡¨
```

## ğŸ¨ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´ç»„ä»¶ç¤ºä¾‹
```vue
<template>
  <el-form :model="bannerForm" :rules="bannerRules">
    <el-form-item label="æ ‡é¢˜" prop="title">
      <el-input v-model="bannerForm.title" />
    </el-form-item>
    
    <el-form-item label="å›¾ç‰‡" prop="filePathUrl">
      <el-upload
        :show-file-list="false"
        :before-upload="beforeUpload"
        action="#"
        :http-request="handleUpload"
      >
        <img v-if="bannerForm.filePathUrl" :src="bannerForm.filePathUrl">
        <el-icon v-else><Plus /></el-icon>
      </el-upload>
    </el-form-item>
    
    <el-form-item label="çŠ¶æ€" prop="status">
      <el-switch v-model="bannerForm.status" />
    </el-form-item>
  </el-form>
</template>

<script setup>
import { reactive } from 'vue'
import { uploadBannerImage } from '@/api/banner'

const bannerForm = reactive({
  title: '',
  fileId: null,
  filePathUrl: '',
  status: true
})

const beforeUpload = (file) => {
  const isImage = file.type.startsWith('image/')
  const isLt2M = file.size / 1024 / 1024 < 2
  
  if (!isImage) {
    ElMessage.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼')
    return false
  }
  if (!isLt2M) {
    ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MBï¼')
    return false
  }
  return true
}

const handleUpload = async ({ file }) => {
  const formData = new FormData()
  formData.append('file', file)
  
  const result = await uploadBannerImage(formData)
  bannerForm.fileId = result.fileId
  bannerForm.filePathUrl = result.filePathUrl
  
  ElMessage.success('ä¸Šä¼ æˆåŠŸ')
}
</script>
```

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ä¸Šä¼ çš„æ–‡ä»¶
```javascript
const handleUpload = async ({ file }) => {
  console.log('ä¸Šä¼ çš„æ–‡ä»¶ï¼š', {
    name: file.name,
    size: file.size,
    type: file.type,
    lastModified: new Date(file.lastModified)
  })
  
  // ... ä¸Šä¼ é€»è¾‘
}
```

### 2. æŸ¥çœ‹ FormData å†…å®¹
```javascript
const formData = new FormData()
formData.append('file', file)

// æŸ¥çœ‹ FormData å†…å®¹
for (let pair of formData.entries()) {
  console.log(pair[0], pair[1])
}
```

### 3. æŸ¥çœ‹å“åº”æ•°æ®
```javascript
const result = await uploadBannerImage(formData)
console.log('ä¸Šä¼ å“åº”ï¼š', {
  fileId: result.fileId,
  filePathUrl: result.filePathUrl,
  å®Œæ•´å“åº”: result
})
```

### 4. é”™è¯¯å¤„ç†
```javascript
try {
  const result = await uploadBannerImage(formData)
  // æˆåŠŸå¤„ç†
} catch (error) {
  console.error('ä¸Šä¼ å¤±è´¥ï¼š', {
    message: error.message,
    response: error.response?.data,
    status: error.response?.status
  })
  ElMessage.error('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•')
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶å¤§å°é™åˆ¶
- âœ… å‰ç«¯é™åˆ¶ï¼š2MB
- âš ï¸ åç«¯å¯èƒ½æœ‰ä¸åŒçš„é™åˆ¶
- ğŸ“ å»ºè®®ï¼šä¸åç«¯ç¡®è®¤æœ€å¤§æ–‡ä»¶å¤§å°

### 2. æ–‡ä»¶ç±»å‹é™åˆ¶
```javascript
// æ”¯æŒçš„å›¾ç‰‡ç±»å‹
const allowedTypes = [
  'image/jpeg',
  'image/png',
  'image/gif',
  'image/webp'
]

const isAllowed = allowedTypes.includes(file.type)
```

### 3. ç½‘ç»œè¶…æ—¶
```javascript
// è®¾ç½®ä¸Šä¼ è¶…æ—¶æ—¶é—´
export function uploadBannerImage(formData) {
  return request({
    url: '/server/common/upload',
    method: 'post',
    data: formData,
    timeout: 30000,  // 30ç§’è¶…æ—¶
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

### 4. è¿›åº¦æ˜¾ç¤º
```javascript
const handleUpload = async ({ file }) => {
  const formData = new FormData()
  formData.append('file', file)
  
  const result = await uploadBannerImage(formData, {
    onUploadProgress: (progressEvent) => {
      const percentCompleted = Math.round(
        (progressEvent.loaded * 100) / progressEvent.total
      )
      console.log('ä¸Šä¼ è¿›åº¦ï¼š', percentCompleted + '%')
    }
  })
}
```

## ğŸ“‹ æ¥å£å¯¹æ¥æ£€æŸ¥æ¸…å•

- [x] URL æ­£ç¡®ï¼š`/server/common/upload`
- [x] æ–¹æ³•æ­£ç¡®ï¼š`POST`
- [x] Content-Typeï¼š`multipart/form-data`
- [x] å‚æ•°åç§°ï¼š`file`
- [x] å“åº”å­—æ®µï¼š`fileId`, `filePathUrl`
- [x] å‰ç«¯æ ¡éªŒï¼šæ–‡ä»¶ç±»å‹ã€å¤§å°
- [x] é”™è¯¯å¤„ç†ï¼štry-catch
- [x] æˆåŠŸæç¤ºï¼šElMessage.success
- [x] å¤±è´¥æç¤ºï¼šElMessage.error
- [x] é¢„è§ˆåŠŸèƒ½ï¼šæ˜¾ç¤ºä¸Šä¼ çš„å›¾ç‰‡

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. å‡†å¤‡æµ‹è¯•å›¾ç‰‡
```
å‡†å¤‡ä¸€å¼ æµ‹è¯•å›¾ç‰‡ï¼š
- æ ¼å¼ï¼šJPG æˆ– PNG
- å°ºå¯¸ï¼š1920x600pxï¼ˆæ¨èï¼‰
- å¤§å°ï¼š< 2MB
```

### 2. æµ‹è¯•ä¸Šä¼ 
```
1. æ‰“å¼€è½®æ’­å›¾ç®¡ç†é¡µé¢
2. ç‚¹å‡»"æ–°å¢è½®æ’­å›¾"
3. ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
4. é€‰æ‹©æµ‹è¯•å›¾ç‰‡
5. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
6. ç¡®è®¤å›¾ç‰‡é¢„è§ˆæ˜¾ç¤º
7. å¡«å†™æ ‡é¢˜
8. æäº¤è¡¨å•
9. æŸ¥çœ‹åˆ—è¡¨ä¸­çš„å›¾ç‰‡
```

### 3. éªŒè¯æ•°æ®
```
// åœ¨æ§åˆ¶å°æŸ¥çœ‹
console.log('fileId:', bannerForm.fileId)
console.log('filePathUrl:', bannerForm.filePathUrl)

// æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å¯è®¿é—®
window.open(bannerForm.filePathUrl)
```

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. å›¾ç‰‡å‹ç¼©
```javascript
// å¯ä»¥åœ¨ä¸Šä¼ å‰å‹ç¼©å›¾ç‰‡
import imageCompression from 'browser-image-compression'

const compressImage = async (file) => {
  const options = {
    maxSizeMB: 1,
    maxWidthOrHeight: 1920
  }
  return await imageCompression(file, options)
}
```

### 2. è£å‰ªåŠŸèƒ½
```javascript
// ä½¿ç”¨ vue-cropper å®ç°å›¾ç‰‡è£å‰ª
import VueCropper from 'vue-cropper'

// è£å‰ªä¸º 1920x600 æ¯”ä¾‹
```

### 3. æ‹–æ‹½ä¸Šä¼ 
```javascript
// Element Plus æ”¯æŒæ‹–æ‹½
<el-upload drag>
  <el-icon><UploadFilled /></el-icon>
  <div>å°†æ–‡ä»¶æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em></div>
</el-upload>
```

---

**é€šç”¨æ–‡ä»¶ä¸Šä¼ æ¥å£å·²å®Œæ•´å¯¹æ¥ï¼** ğŸ“¤âœ¨

**æ¥å£ä¿¡æ¯**ï¼š
- URL: `/server/common/upload`
- è¿”å›: `{ fileId, filePathUrl }`
- å·²åœ¨è½®æ’­å›¾ç®¡ç†ä¸­ä½¿ç”¨

